(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerpolicy&&(s.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?s.credentials="include":i.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();function S(e,r,t){const n=e.createBuffer({label:"Ambient light buffer",size:4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),i=new Float32Array([.4]);e.queue.writeBuffer(n,0,i);const s=e.createBuffer({label:"Point light buffer",size:8*8*t,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),o=new Float32Array(8*t),a=4,h=20;for(var l=0;l<t;l++){const p=8*l;o[p+2]=-50,o[p+4]=a,o[p+5]=h}e.queue.writeBuffer(s,0,o);const f=e.createBuffer({label:"point light count buffer",size:1*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});return e.queue.writeBuffer(f,0,new Int32Array([t])),{bindGroup:e.createBindGroup({label:"lightBindGroup",layout:r,entries:[{binding:0,resource:{buffer:n}},{binding:1,resource:{buffer:s}},{binding:2,resource:{buffer:f}}]}),pointLights:o,pointBuffer:s}}var L=1e-6,U=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var e=0,r=arguments.length;r--;)e+=arguments[r]*arguments[r];return Math.sqrt(e)});function G(){var e=new U(16);return U!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function T(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function R(e,r,t){var n=r[0],i=r[1],s=r[2],o=r[3],a=r[4],h=r[5],l=r[6],f=r[7],u=r[8],p=r[9],c=r[10],d=r[11],g=r[12],m=r[13],b=r[14],B=r[15],v=t[0],y=t[1],x=t[2],w=t[3];return e[0]=v*n+y*a+x*u+w*g,e[1]=v*i+y*h+x*p+w*m,e[2]=v*s+y*l+x*c+w*b,e[3]=v*o+y*f+x*d+w*B,v=t[4],y=t[5],x=t[6],w=t[7],e[4]=v*n+y*a+x*u+w*g,e[5]=v*i+y*h+x*p+w*m,e[6]=v*s+y*l+x*c+w*b,e[7]=v*o+y*f+x*d+w*B,v=t[8],y=t[9],x=t[10],w=t[11],e[8]=v*n+y*a+x*u+w*g,e[9]=v*i+y*h+x*p+w*m,e[10]=v*s+y*l+x*c+w*b,e[11]=v*o+y*f+x*d+w*B,v=t[12],y=t[13],x=t[14],w=t[15],e[12]=v*n+y*a+x*u+w*g,e[13]=v*i+y*h+x*p+w*m,e[14]=v*s+y*l+x*c+w*b,e[15]=v*o+y*f+x*d+w*B,e}function F(e,r,t){var n=t[0],i=t[1],s=t[2],o,a,h,l,f,u,p,c,d,g,m,b;return r===e?(e[12]=r[0]*n+r[4]*i+r[8]*s+r[12],e[13]=r[1]*n+r[5]*i+r[9]*s+r[13],e[14]=r[2]*n+r[6]*i+r[10]*s+r[14],e[15]=r[3]*n+r[7]*i+r[11]*s+r[15]):(o=r[0],a=r[1],h=r[2],l=r[3],f=r[4],u=r[5],p=r[6],c=r[7],d=r[8],g=r[9],m=r[10],b=r[11],e[0]=o,e[1]=a,e[2]=h,e[3]=l,e[4]=f,e[5]=u,e[6]=p,e[7]=c,e[8]=d,e[9]=g,e[10]=m,e[11]=b,e[12]=o*n+f*i+d*s+r[12],e[13]=a*n+u*i+g*s+r[13],e[14]=h*n+p*i+m*s+r[14],e[15]=l*n+c*i+b*s+r[15]),e}function q(e,r,t){var n=t[0],i=t[1],s=t[2];return e[0]=r[0]*n,e[1]=r[1]*n,e[2]=r[2]*n,e[3]=r[3]*n,e[4]=r[4]*i,e[5]=r[5]*i,e[6]=r[6]*i,e[7]=r[7]*i,e[8]=r[8]*s,e[9]=r[9]*s,e[10]=r[10]*s,e[11]=r[11]*s,e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],e}function I(e,r,t){var n=Math.sin(t),i=Math.cos(t),s=r[4],o=r[5],a=r[6],h=r[7],l=r[8],f=r[9],u=r[10],p=r[11];return r!==e&&(e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e[4]=s*i+l*n,e[5]=o*i+f*n,e[6]=a*i+u*n,e[7]=h*i+p*n,e[8]=l*i-s*n,e[9]=f*i-o*n,e[10]=u*i-a*n,e[11]=p*i-h*n,e}function V(e,r,t){var n=Math.sin(t),i=Math.cos(t),s=r[0],o=r[1],a=r[2],h=r[3],l=r[8],f=r[9],u=r[10],p=r[11];return r!==e&&(e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e[0]=s*i-l*n,e[1]=o*i-f*n,e[2]=a*i-u*n,e[3]=h*i-p*n,e[8]=s*n+l*i,e[9]=o*n+f*i,e[10]=a*n+u*i,e[11]=h*n+p*i,e}function D(e,r,t){var n=Math.sin(t),i=Math.cos(t),s=r[0],o=r[1],a=r[2],h=r[3],l=r[4],f=r[5],u=r[6],p=r[7];return r!==e&&(e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15]),e[0]=s*i+l*n,e[1]=o*i+f*n,e[2]=a*i+u*n,e[3]=h*i+p*n,e[4]=l*i-s*n,e[5]=f*i-o*n,e[6]=u*i-a*n,e[7]=p*i-h*n,e}function N(e,r,t,n,i){var s=1/Math.tan(r/2),o;return e[0]=s/t,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,i!=null&&i!==1/0?(o=1/(n-i),e[10]=(i+n)*o,e[14]=2*i*n*o):(e[10]=-1,e[14]=-2*n),e}var Y=N;function j(e,r,t,n){var i,s,o,a,h,l,f,u,p,c,d=r[0],g=r[1],m=r[2],b=n[0],B=n[1],v=n[2],y=t[0],x=t[1],w=t[2];return Math.abs(d-y)<L&&Math.abs(g-x)<L&&Math.abs(m-w)<L?T(e):(f=d-y,u=g-x,p=m-w,c=1/Math.hypot(f,u,p),f*=c,u*=c,p*=c,i=B*p-v*u,s=v*f-b*p,o=b*u-B*f,c=Math.hypot(i,s,o),c?(c=1/c,i*=c,s*=c,o*=c):(i=0,s=0,o=0),a=u*o-p*s,h=p*i-f*o,l=f*s-u*i,c=Math.hypot(a,h,l),c?(c=1/c,a*=c,h*=c,l*=c):(a=0,h=0,l=0),e[0]=i,e[1]=a,e[2]=f,e[3]=0,e[4]=s,e[5]=h,e[6]=u,e[7]=0,e[8]=o,e[9]=l,e[10]=p,e[11]=0,e[12]=-(i*d+s*g+o*m),e[13]=-(a*d+h*g+l*m),e[14]=-(f*d+u*g+p*m),e[15]=1,e)}function X(){var e=new U(3);return U!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function P(e,r,t){var n=new U(3);return n[0]=e,n[1]=r,n[2]=t,n}(function(){var e=X();return function(r,t,n,i,s,o){var a,h;for(t||(t=3),n||(n=0),i?h=Math.min(i*t+n,r.length):h=r.length,a=n;a<h;a+=t)e[0]=r[a],e[1]=r[a+1],e[2]=r[a+2],s(e,e,o),r[a]=e[0],r[a+1]=e[1],r[a+2]=e[2];return r}})();const k=new Float32Array([.5,.5,.5,1,0,0,0,1,.5,.5,-.5,1,0,0,1,1,.5,-.5,.5,1,0,0,0,0,.5,-.5,-.5,1,0,0,1,0,-.5,.5,-.5,-1,0,0,0,1,-.5,.5,.5,-1,0,0,1,1,-.5,-.5,-.5,-1,0,0,0,0,-.5,-.5,.5,-1,0,0,1,0,-.5,.5,-.5,0,1,0,0,1,.5,.5,-.5,0,1,0,1,1,-.5,.5,.5,0,1,0,0,0,.5,.5,.5,0,1,0,1,0,-.5,-.5,.5,0,-1,0,0,1,.5,-.5,.5,0,-1,0,1,1,-.5,-.5,-.5,0,-1,0,0,0,.5,-.5,-.5,0,-1,0,1,0,-.5,.5,.5,0,0,1,0,1,.5,.5,.5,0,0,1,1,1,-.5,-.5,.5,0,0,1,0,0,.5,-.5,.5,0,0,1,1,0,.5,.5,-.5,0,0,-1,0,1,-.5,.5,-.5,0,0,-1,1,1,.5,-.5,-.5,0,0,-1,0,0,-.5,-.5,-.5,0,0,-1,1,0]),H=new Uint16Array([0,2,1,2,3,1,4,6,5,6,7,5,8,10,9,10,11,9,12,14,13,14,15,13,16,18,17,18,19,17,20,22,21,22,23,21]),W=24,K=36,M={vertex:k,index:H,vertexCount:W,indexCount:K},Z=P(0,0,0),$=P(0,1,0);function J(e,r=60/180*Math.PI,t=.1,n=100,i={x:0,y:0,z:0}){const s=G(),o=P(i.x,i.y,i.z);F(s,s,o),j(s,o,Z,$);const a=G();return Y(a,r,e,t,n),R(a,a,s),a}var A=function(e,r){return A=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])},A(e,r)};function O(e,r){if(typeof r!="function"&&r!==null)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function t(){this.constructor=e}A(e,r),e.prototype=r===null?Object.create(r):(t.prototype=r.prototype,new t)}var C,_=function(){function e(){}return e._xfnv1a=function(r){for(var t=2166136261,n=0;n<r.length;n++)t=Math.imul(t^r.charCodeAt(n),16777619);return function(){return t+=t<<13,t^=t>>>7,t+=t<<3,t^=t>>>17,(t+=t<<5)>>>0}},e}(),Q=function(e){function r(t){var n=e.call(this)||this;return n.a=r._xfnv1a(t)(),n}return O(r,e),r.prototype.next=function(){var t=this.a+=1831565813;return t=Math.imul(t^t>>>15,1|t),(((t^=t+Math.imul(t^t>>>7,61|t))^t>>>14)>>>0)/4294967296},r}(_),ee=function(e){function r(t){var n=e.call(this)||this,i=r._xfnv1a(t);return n.a=i(),n.b=i(),n.c=i(),n.d=i(),n}return O(r,e),r.prototype.next=function(){this.a>>>=0,this.b>>>=0,this.c>>>=0,this.d>>>=0;var t=this.a+this.b|0;return this.a=this.b^this.b>>>9,this.b=this.c+(this.c<<3)|0,this.c=this.c<<21|this.c>>>11,this.d=this.d+1|0,t=t+this.d|0,this.c=this.c+t|0,(t>>>0)/4294967296},r}(_),re=function(e){function r(t){var n=e.call(this)||this,i=r._xfnv1a(t);return n.a=i(),n.b=i(),n.c=i(),n.d=i(),n}return O(r,e),r.prototype.next=function(){var t=this.b<<9,n=5*this.a;return n=n<<7|9*(n>>>25),this.c^=this.a,this.d^=this.b,this.b^=this.c,this.a^=this.d,this.c^=t,this.d=this.d<<11|this.d>>>21,(n>>>0)/4294967296},r}(_);(function(e){e.sfc32="sfc32",e.mulberry32="mulberry32",e.xoshiro128ss="xoshiro128ss"})(C||(C={}));var te=function(){function e(r,t){t===void 0&&(t=C.sfc32),this.str=r,this.prng=t,this.generator=this._initializeGenerator()}return e.prototype.next=function(){return this.generator.next()},e.prototype._initializeGenerator=function(){if(function(t){return t===null}(r=this.str)||function(t){return t===void 0}(r))return this.wrap();var r;switch(this.prng){case"sfc32":return new ee(this.str);case"mulberry32":return new Q(this.str);case"xoshiro128ss":return new re(this.str);default:return this.wrap()}},e.prototype.wrap=function(){return{next:function(){return Math.random()}}},e}();const ne=Math.random()+"";function ie(e,r,t,n,i){const s=[],o=new te(ne);for(let m=0;m<t;m++){const b=P(o.next()*50-25,o.next()*50-25,-30-o.next()*60),B=P(0,0,-2),v=P(.6,.6,.6);s.push({position:b,rotation:B,scale:v})}const a=e.createBuffer({size:M.vertex.byteLength,usage:GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST}),h=e.createBuffer({size:M.index.byteLength,usage:GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST});e.queue.writeBuffer(a,0,M.vertex),e.queue.writeBuffer(h,0,M.index);const l={...M,vertex:a,index:h},f=[[.82,.82,.48],[.67,.45,.49],[.3,.4,.5],[.45,.29,.51],[.27,.39,.24]],u=new Float32Array(4*t),p=e.createBuffer({label:"colourBuffer",size:4*4*t,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});for(let m=0;m<t;m++){const b=m%f.length;u.set(f[b],m*4)}e.queue.writeBuffer(p,0,u);const c=e.createBuffer({label:"mvBuffer",size:4*4*4*t,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),d=e.createBuffer({label:"projectionBuffer",size:4*4*4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),g=e.createBindGroup({layout:r.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:c}},{binding:1,resource:{buffer:d}},{binding:2,resource:{buffer:p}}]});return e.queue.writeBuffer(d,0,J(n/i)),{transforms:s,indexedBuffer:l,bindGroups:[g],mvBuffer:c}}const z=`@group(0) @binding(0) var<storage> modelViews : array<mat4x4<f32>>;\r
@group(0) @binding(1) var<uniform> projection : mat4x4<f32>;\r
@group(0) @binding(2) var<storage> colours : array<vec4<f32>>;\r
\r
struct VertexOutput {\r
    @builtin(position) Position: vec4<f32>,\r
    @location(0) fragPosition: vec3<f32>,\r
    @location(1) fragNormal: vec3<f32>,\r
    @location(2) fragUV: vec2<f32>,\r
    @location(3) fragColour: vec4<f32>\r
};\r
\r
@vertex\r
fn main(@builtin(instance_index) index: u32, @location(0) position: vec3<f32>, @location(1) normal: vec3<f32>, @location(2) uv: vec2<f32>) -> VertexOutput {\r
    let modelview = modelViews[index];\r
    let mvp = projection * modelview;\r
    let pos = vec4<f32>(position, 1.0);\r
\r
    var output: VertexOutput;\r
    output.Position = mvp * pos;\r
    output.fragPosition = (modelview * pos).xyz;\r
    output.fragNormal = (modelview * vec4<f32>(normal, 0.0)).xyz;\r
    output.fragUV = uv;\r
    output.fragColour = colours[index];\r
    return output;\r
}\r
\r
@group(1) @binding(0) var<uniform> ambientIntensity : f32;\r
@group(1) @binding(1) var<storage> pointLights : array<vec4<f32>>;\r
@group(1) @binding(2) var<uniform> numberOfPointLights: i32;\r
@fragment\r
fn fs_main(@location(0) pos: vec3<f32>, @location(1) normal: vec3<f32>, @location(2) uv: vec2<f32>, @location(3) colour: vec4<f32>) -> @location(0) vec4<f32> {\r
    let ambintLightColor: vec3<f32> = vec3(1.0, 1.0, 1.0);\r
    let pointLightColor: vec3<f32> = vec3(1.0, 1.0, 1.0);\r
    let dirLightColor: vec3<f32> = vec3(1.0, 1.0, 1.0);\r
\r
    var lightResult: vec3<f32> = vec3(0.0, 0.0, 0.0);\r
\r
    lightResult += ambintLightColor * ambientIntensity;\r
\r
    for (var i: i32 = 0; i < numberOfPointLights; i = i + 1) {\r
        var offset = 2 * i;\r
        var pointPosition = pointLights[offset].xyz;\r
        var pointIntensity: f32 = pointLights[offset + 1][0];\r
        var pointRadius: f32 = pointLights[offset + 1][1];\r
        var L = pointPosition - pos;\r
        var distance = length(L);\r
        if distance < pointRadius {\r
            var diffuse: f32 = max(dot(normalize(L), normal), 0.0);\r
            var distanceFactor: f32 = pow(1.0 - distance / pointRadius, 2.0);\r
            lightResult += pointLightColor * pointIntensity * diffuse * distanceFactor;\r
        }\r
    }\r
\r
    return vec4<f32>(colour.rgb * lightResult, 1.0);\r
}`;async function se(e,r){const t={layout:"auto",vertex:{module:e.createShaderModule({code:z}),entryPoint:"main",buffers:[{arrayStride:32,attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:20,format:"float32x2"}]}]},primitive:{topology:"triangle-list",cullMode:"back"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},fragment:{module:e.createShaderModule({code:z}),entryPoint:"fs_main",targets:[{format:r}]}};return await e.createRenderPipelineAsync(t)}async function oe(){var r;const e=await((r=navigator.gpu)==null?void 0:r.requestAdapter());return await(e==null?void 0:e.requestDevice())}function ae(e,r,t){const n=e.getContext("webgpu");return n.configure({device:r,format:t,alphaMode:"opaque"}),n}function fe(e,r,t,n,i,s,o){const a={colorAttachments:[{view:r,clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:s.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}},h=e.createCommandEncoder(),l=h.beginRenderPass(a);l.setPipeline(t),i.forEach((f,u)=>l.setBindGroup(u,f)),l.setVertexBuffer(0,n.vertex),l.setIndexBuffer(n.index,"uint16"),l.drawIndexed(n.indexCount,o),l.end(),e.queue.submit([h.finish()])}function ce(e,r,t,n,i,s,o,a){const h=ae(t,e,n),l=e.createTexture({size:{width:t.width,height:t.height},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT});return()=>{const f=Date.now()/1e3;for(var u=0;u<a;u++){const c=8*u,d=2*Math.PI/a*u;s.pointLights[c+0]=10*Math.sin(f/2+d),s.pointLights[c+1]=10*Math.cos(f/2+d),s.pointLights[c+2]=-50+25*Math.cos(f/2+d)}e.queue.writeBuffer(s.pointBuffer,0,s.pointLights);const p=new Float32Array(o*4*4);for(let c=0;c<o;c++){const d=i.transforms[c];d.rotation[0]=Math.sin(f+c),d.rotation[1]=Math.cos(f+c);const g=G();F(g,g,d.position),I(g,g,d.rotation[0]),V(g,g,d.rotation[1]),D(g,g,d.rotation[2]),q(g,g,d.scale),p.set(g,c*4*4)}e.queue.writeBuffer(i.mvBuffer,0,p),fe(e,h.getCurrentTexture().createView(),r,i.indexedBuffer,[...i.bindGroups,s.bindGroup],l,o)}}function le(){let e=0;const r=[],t=new Map,n=()=>{for(;r.length;)t.delete(r.pop());t.forEach(s=>{s()}),requestAnimationFrame(n)};return requestAnimationFrame(n),s=>{const o=e++;return t.set(o,s),()=>{r.push(o)}}}(async()=>{var h,l;const e=document.querySelector("canvas");e.width=500,e.height=500;const r=await oe(),t=le();let n,i=500,s=2;const o=()=>{i=E("instances"),s=E("lights"),a()},a=async()=>{var g;n==null||n();const f=(g=navigator.gpu)==null?void 0:g.getPreferredCanvasFormat(),u=await se(r,f),p=S(r,u.getBindGroupLayout(1),s),c=ie(r,u,i,e.width,e.height),d=ce(r,u,e,f,c,p,i,s);n=t(d)};navigator.gpu?(a(),(h=document.getElementById("instances"))==null||h.addEventListener("input",o),(l=document.getElementById("lights"))==null||l.addEventListener("input",o)):document.getElementsByClassName("content")[0].innerHTML="Browser doesn't support Webgpu"})();function E(e){var t;const r=document.getElementById(e);return parseInt((t=r==null?void 0:r.value)!=null?t:"0")}
